#!/usr/bin/env bash
set -euo pipefail

# Declarative package installation for multiple OS types
# Automatically installs packages defined in .chezmoidata/packages.yaml
# Only runs when the package list changes (tracked by hash comment)

# Hash of package list for change detection (includes all OS types)
# packages: {{ if .is_arch }}{{ list .packages.cachyos.pacman .packages.cachyos.aur | toJson | sha256sum }}{{ else if .is_debian }}{{ .packages.debian.apt | toJson | sha256sum }}{{ end }}

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
{{ if .is_arch -}}
echo "ğŸ“¦ Installing system packages for {{ .os_id }}"
{{ else if .is_debian -}}
echo "ğŸ“¦ Installing system packages for Debian"
{{ else -}}
echo "ğŸ“¦ Package installation skipped (unsupported OS: {{ .os_id }})"
exit 0
{{ end -}}
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

{{ if .is_arch -}}
# =============================================================================
# Arch/CachyOS Installation (pacman + AUR)
# =============================================================================

# Track what needs installation
PACMAN_PACKAGES=()
AUR_PACKAGES=()

# Check pacman packages
{{ range .packages.cachyos.pacman -}}
if ! pacman -Qi "{{ . }}" &>/dev/null; then
    PACMAN_PACKAGES+=("{{ . }}")
    echo "ğŸ“‹ Will install (pacman): {{ . }}"
else
    echo "âœ“ Already installed: {{ . }}"
fi
{{ end }}

# Check AUR packages (if section exists)
{{- if .packages.cachyos.aur }}
{{ range .packages.cachyos.aur -}}
if ! pacman -Qi "{{ . }}" &>/dev/null; then
    AUR_PACKAGES+=("{{ . }}")
    echo "ğŸ“‹ Will install (AUR): {{ . }}"
else
    echo "âœ“ Already installed: {{ . }}"
fi
{{ end }}
{{- end }}

# Install pacman packages
if [ ${#PACMAN_PACKAGES[@]} -gt 0 ]; then
    echo ""
    echo "Installing ${#PACMAN_PACKAGES[@]} pacman package(s)..."
    sudo pacman -S --noconfirm "${PACMAN_PACKAGES[@]}"
    echo "âœ“ Pacman packages installed successfully"
fi

# Install AUR packages
if [ ${#AUR_PACKAGES[@]} -gt 0 ]; then
    echo ""
    echo "Installing ${#AUR_PACKAGES[@]} AUR package(s)..."
    {{ .aur_helper }} -S --noconfirm "${AUR_PACKAGES[@]}"
    echo "âœ“ AUR packages installed successfully"
fi

# Summary
if [ ${#PACMAN_PACKAGES[@]} -eq 0 ] && [ ${#AUR_PACKAGES[@]} -eq 0 ]; then
    echo ""
    echo "âœ“ All packages already installed"
fi

{{ else if .is_debian -}}
# =============================================================================
# Debian/Ubuntu Installation (apt)
# =============================================================================

# Track what needs installation
APT_PACKAGES=()

# Check apt packages
{{ range .packages.debian.apt -}}
if ! dpkg -l "{{ . }}" 2>/dev/null | grep -q "^ii"; then
    APT_PACKAGES+=("{{ . }}")
    echo "ğŸ“‹ Will install (apt): {{ . }}"
else
    echo "âœ“ Already installed: {{ . }}"
fi
{{ end }}

# Install apt packages
if [ ${#APT_PACKAGES[@]} -gt 0 ]; then
    echo ""
    echo "Updating package lists..."
    sudo apt-get update
    echo ""
    echo "Installing ${#APT_PACKAGES[@]} apt package(s)..."
    sudo apt-get install -y "${APT_PACKAGES[@]}"
    echo "âœ“ APT packages installed successfully"
else
    echo ""
    echo "âœ“ All packages already installed"
fi

{{ end -}}

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Package installation complete"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ’¡ To add more packages:"
echo "   1. Edit: ~/.local/share/chezmoi/home/.chezmoidata/packages.yaml"
echo "   2. Run:  chezmoi apply"
echo ""
{{ if .is_arch -}}
echo "   Supported sections: pacman (official repos), aur (AUR packages)"
{{ else if .is_debian -}}
echo "   Supported section: apt (Debian/Ubuntu packages)"
echo ""
echo "   NOTE: Many CLI tools (helix, lf, lazygit, zoxide, bat) are best"
echo "   installed via cargo or downloaded from GitHub releases on Debian."
{{ end -}}
