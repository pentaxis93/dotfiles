#!/usr/bin/env bash
# ════════════════════════════════════════════════════════════════════════════
# Zen Browser Configuration Setup
# Generated by chezmoi from run_onchange_setup-zen-browser.sh.tmpl
#
# Purpose: Deploy user.js and userChrome.css to Zen Browser profile
# Trigger: Runs whenever zen-browser-config/ files change
# ════════════════════════════════════════════════════════════════════════════

set -euo pipefail

# ────────────────────────────────────────────────────────────────────────────
# Configuration
# ────────────────────────────────────────────────────────────────────────────

ZEN_BASE_DIR="$HOME/.zen"
CONFIG_SOURCE_DIR="$HOME/.zen-browser-config"

echo "═══════════════════════════════════════════════════════════"
echo "  Zen Browser Configuration Setup"
echo "═══════════════════════════════════════════════════════════"
echo ""

# ────────────────────────────────────────────────────────────────────────────
# Check if Zen Browser is installed
# ────────────────────────────────────────────────────────────────────────────

if ! command -v zen-browser &> /dev/null; then
    echo "⚠️  Zen Browser not found. Install zen-browser-bin from AUR first."
    echo "   Run: yay -S zen-browser-bin"
    exit 0
fi

# ────────────────────────────────────────────────────────────────────────────
# Check if Zen profile directory exists
# ────────────────────────────────────────────────────────────────────────────

if [[ ! -d "$ZEN_BASE_DIR" ]]; then
    echo "⚠️  Zen Browser profile directory not found: $ZEN_BASE_DIR"
    echo "   Launch Zen Browser at least once to create the profile."
    echo "   Then run 'chezmoi apply' again to deploy configurations."
    exit 0
fi

# ────────────────────────────────────────────────────────────────────────────
# Find the active Zen profile
# ────────────────────────────────────────────────────────────────────────────

# Look for profiles ending with .default or containing "release" or "default"
ZEN_PROFILE=$(find "$ZEN_BASE_DIR" -maxdepth 1 -type d \
    \( -name "*.default" -o -name "*.Default*" -o -name "*release*" \) \
    | head -n 1)

if [[ -z "$ZEN_PROFILE" ]]; then
    echo "⚠️  Could not find Zen Browser profile directory."
    echo "   Expected format: $ZEN_BASE_DIR/*.default or *.Default*"
    echo ""
    echo "   Available directories:"
    ls -1d "$ZEN_BASE_DIR"/*/ 2>/dev/null || echo "   (none)"
    echo ""
    echo "   Launch Zen Browser once, then run 'chezmoi apply' again."
    exit 0
fi

echo "✓ Found Zen Browser profile:"
echo "  $ZEN_PROFILE"
echo ""

# ────────────────────────────────────────────────────────────────────────────
# Deploy user.js
# ────────────────────────────────────────────────────────────────────────────

if [[ -f "$CONFIG_SOURCE_DIR/user.js" ]]; then
    echo "→ Deploying user.js..."
    cp "$CONFIG_SOURCE_DIR/user.js" "$ZEN_PROFILE/user.js"
    echo "  ✓ user.js deployed to profile root"
else
    echo "⚠️  user.js not found in $CONFIG_SOURCE_DIR"
    echo "   This should have been created by chezmoi."
fi

# ────────────────────────────────────────────────────────────────────────────
# Deploy userChrome.css
# ────────────────────────────────────────────────────────────────────────────

# Create chrome/ directory if it doesn't exist
CHROME_DIR="$ZEN_PROFILE/chrome"
if [[ ! -d "$CHROME_DIR" ]]; then
    echo "→ Creating chrome/ directory..."
    mkdir -p "$CHROME_DIR"
    echo "  ✓ chrome/ directory created"
fi

if [[ -f "$CONFIG_SOURCE_DIR/userChrome.css" ]]; then
    echo "→ Deploying userChrome.css..."
    cp "$CONFIG_SOURCE_DIR/userChrome.css" "$CHROME_DIR/userChrome.css"
    echo "  ✓ userChrome.css deployed to chrome/"
else
    echo "⚠️  userChrome.css not found in $CONFIG_SOURCE_DIR"
    echo "   This should have been created by chezmoi."
fi

# ────────────────────────────────────────────────────────────────────────────
# Success Message
# ────────────────────────────────────────────────────────────────────────────

echo ""
echo "═══════════════════════════════════════════════════════════"
echo "  ✓ Zen Browser configuration deployed successfully!"
echo "═══════════════════════════════════════════════════════════"
echo ""
echo "Next steps:"
echo "  1. Restart Zen Browser to apply user.js preferences"
echo "  2. userChrome.css changes apply immediately (no restart needed)"
echo ""
echo "Live CSS editing:"
echo "  Press Ctrl+Shift+Alt+I to open Browser Toolbox"
echo "  Navigate to Style Editor → Filter for 'userChrome'"
echo "  Edit and save (Ctrl+S) for instant preview"
echo ""
echo "Kanagawa Dragon theme colors are now applied system-wide!"
echo ""
