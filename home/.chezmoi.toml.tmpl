{{- /* Machine detection */ -}}
{{- $hostname := .chezmoi.hostname -}}

{{- /* Machine type detection - determines configuration scope */ -}}
{{- /* VPS detection: no GUI, systemd present, typically a known hostname */ -}}
{{- $hasDisplay := or (env "DISPLAY") (env "WAYLAND_DISPLAY") -}}
{{- $osRelease := output "sh" "-c" "cat /etc/os-release 2>/dev/null | grep '^ID=' | cut -d= -f2 | tr -d '\"'" | trim -}}
{{- $isDebian := eq $osRelease "debian" -}}
{{- $isCachyOS := eq $osRelease "cachyos" -}}
{{- $isArch := or (eq $osRelease "arch") $isCachyOS -}}
{{- /* Default machine type based on OS and display presence */ -}}
{{- $defaultMachineType := "desktop" -}}
{{- if and $isDebian (not $hasDisplay) -}}
{{-   $defaultMachineType = "vps" -}}
{{- end -}}

{{- /* Auto-detect system defaults */ -}}
{{- $envEditor := env "EDITOR" -}}
{{- $visualEditor := env "VISUAL" -}}
{{- $defaultEditor := "helix" -}}
{{- if $envEditor -}}
{{-   $defaultEditor = $envEditor -}}
{{- else if $visualEditor -}}
{{-   $defaultEditor = $visualEditor -}}
{{- end -}}
{{- $hasBattery := output "sh" "-c" "ls /sys/class/power_supply/BAT* 2>/dev/null | head -1" | trim -}}
{{- $defaultIsLaptop := ne $hasBattery "" -}}
{{- $sessionType := env "XDG_SESSION_TYPE" -}}
{{- $waylandDisplay := env "WAYLAND_DISPLAY" -}}
{{- $defaultDisplayServer := "x11" -}}
{{- if or (eq $sessionType "wayland") $waylandDisplay -}}
{{-   $defaultDisplayServer = "wayland" -}}
{{- end -}}
{{- $runningNiri := output "sh" "-c" "pgrep -x niri >/dev/null && echo yes || true" | trim -}}
{{- $runningSway := output "sh" "-c" "pgrep -x sway >/dev/null && echo yes || true" | trim -}}
{{- $defaultCompositor := "niri" -}}
{{- if eq $runningNiri "yes" -}}
{{-   $defaultCompositor = "niri" -}}
{{- else if eq $runningSway "yes" -}}
{{-   $defaultCompositor = "sway" -}}
{{- end -}}

{{- /* Personal identity prompts - no defaults for privacy */ -}}
{{- $name := promptStringOnce . "name" "Your name" -}}
{{- $email := promptStringOnce . "email" "Your personal email" -}}

{{- /* Git/GitHub identity - can default to personal values */ -}}
{{- $gitName := promptStringOnce . "git_name" "Your name for git commits" $name -}}
{{- $gitEmail := promptStringOnce . "git_email" "Your email for git commits" $email -}}

{{- /* System configuration with auto-detected defaults */ -}}
{{- $editor := promptStringOnce . "editor" "Your preferred editor" $defaultEditor -}}
{{- /* is_laptop is auto-detected from battery presence - no prompt needed */ -}}
{{- $isLaptop := $defaultIsLaptop -}}

{{- /* Machine type: desktop, laptop, vps - determines which configs to apply */ -}}
{{- $machineType := promptStringOnce . "machine_type" "Machine type (desktop/laptop/vps)" $defaultMachineType -}}
{{- $isVPS := eq $machineType "vps" -}}
{{- $hasGUI := not $isVPS -}}

{{- /* Optional but useful with better defaults - only prompt on GUI machines */ -}}
{{- $aurHelper := "yay" -}}
{{- $displayServer := "none" -}}
{{- $compositor := "none" -}}
{{- if $hasGUI -}}
{{-   $aurHelper = promptStringOnce . "aur_helper" "AUR helper (yay/paru)" "yay" -}}
{{-   $displayServer = promptStringOnce . "display_server" "Display server (wayland/x11)" $defaultDisplayServer -}}
{{-   $compositor = promptStringOnce . "compositor" "Window manager/compositor" $defaultCompositor -}}
{{- end -}}

[data]
    # Machine identity
    hostname = {{ $hostname | quote }}

    # Personal identity
    name = {{ $name | quote }}
    email = {{ $email | quote }}

    # Git identity (for commits)
    git_name = {{ $gitName | quote }}
    git_email = {{ $gitEmail | quote }}

    # Machine type and capabilities
    machine_type = {{ $machineType | quote }}
    is_vps = {{ $isVPS }}
    has_gui = {{ $hasGUI }}
    is_laptop = {{ $isLaptop }}

    # OS detection
    os_id = {{ $osRelease | quote }}
    is_arch = {{ $isArch }}
    is_debian = {{ $isDebian }}

    # Package management (only relevant for Arch-based)
    aur_helper = {{ $aurHelper | quote }}

    # Display server (only relevant for GUI machines)
    display_server = {{ $displayServer | quote }}
    compositor = {{ $compositor | quote }}

    # Editor preference
    editor = {{ $editor | quote }}